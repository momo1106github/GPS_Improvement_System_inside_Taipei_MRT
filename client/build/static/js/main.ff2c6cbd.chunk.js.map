{"version":3,"sources":["hooks/useRoute.js","Components/Header.js","Components/Map.js","Containers/Recorder.js","hooks/useSensor.js","Containers/WebCam.js","Containers/MapController.js","App.js","reportWebVitals.js","index.js"],"names":["useRoute","useState","lng","setLng","lat","setLat","id","setId","getUserId","Buffer","from","toString","a","axios","get","data","console","log","sendAudio","blob","formData","FormData","append","post","headers","Accept","Authorization","result","parseFloat","sendPic","imgSrc","file","dataURLtoFile","dataurl","filename","arr","split","mime","match","bstr","atob","n","length","u8arr","Uint8Array","charCodeAt","File","type","sendBearing","bearing","Header","className","Map","mapContainer","zoom","onMove","ref","Recorder","record","setRecord","mimeType","onStop","recordedBlob","onData","strokeColor","timeSlice","backgroundColor","onClick","useSensor","setBearing","orientation","sensor","AbsoluteOrientationSensor","frequency","Promise","all","navigator","permissions","query","name","then","results","every","state","addEventListener","euler","THREE","quaternion","Math","PI","setFromQuaternion","z","event","error","start","videoConstraints","width","height","facingMode","WebCamContainer","webcamRef","React","useRef","capture","useCallback","imageSrc","current","getScreenshot","audio","screenshotFormat","mapboxgl","accessToken","MapController","map","marker","setMarker","lastBearing","setLastBearing","useEffect","flyTo","center","setLngLat","addTo","abs","container","style","pitch","Marker","color","draggable","App","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"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","file":"static/js/main.ff2c6cbd.chunk.js","sourcesContent":["import axios from \"axios\";\nimport { useState, useEffect } from \"react\";\n\nconst useRoute = () => {\n  const [lng, setLng] = useState(121.573145);\n  const [lat, setLat] = useState(24.998241);\n  const [id, setId] = useState();\n  const development = process.env.NODE_ENV !== \"production\";\n  const token = Buffer.from(`111:${id}`, \"utf8\").toString(\"base64\");\n  const getUserId = async () => {\n    const { data } = await axios.get(\"/id\");\n    console.log(\"getUserId\", data);\n    setId(data);\n  };\n\n  const sendAudio = async (blob) => {\n    let formData = new FormData();\n    formData.append(\"wav_file\", blob.blob);\n    // console.log(blob);\n\n    if (!id) await getUserId();\n    console.log(\"id:\", id);\n    const result = await axios.post(\"/audio\", formData, {\n      headers: {\n        Accept: \"*/*\",\n        \"Content-Type\": \"multipart/form-data\",\n        Authorization: `Basic ${Buffer.from(`111:${id}`, \"utf8\").toString(\n          \"base64\"\n        )}`,\n      },\n    });\n\n    setLng(parseFloat(result.data[0]));\n    setLat(parseFloat(result.data[1]));\n  };\n\n  const sendPic = async (imgSrc) => {\n    if (!id) await getUserId();\n    let formData = new FormData();\n    const file = dataURLtoFile(imgSrc);\n    formData.append(\"image_file\", file);\n    formData.append(\"user_id\", id);\n    // console.log(formData.get(\"image_file\"));\n    const result = await axios.post(\"/image\", formData, {\n      headers: {\n        \"Content-Type\": \"multipart/form-data\",\n        Authorization: `Basic ${Buffer.from(`111:${id}`, \"utf8\").toString(\n          \"base64\"\n        )}`,\n      },\n    });\n    console.log(result);\n  };\n\n  const sendBearing = async (bearing) => {\n    if (!id) await getUserId();\n    console.log(\"send Bearing\", bearing);\n    const result = await axios.post(\n      \"/bearing\",\n      { bearing: bearing },\n      {\n        headers: {\n          Authorization: `Basic ${Buffer.from(`111:${id}`, \"utf8\").toString(\n            \"base64\"\n          )}`,\n        },\n      }\n    );\n    console.log(result);\n  };\n\n  const dataURLtoFile = (dataurl, filename) => {\n    const arr = dataurl.split(\",\");\n    const mime = arr[0].match(/:(.*?);/)[1];\n    const bstr = atob(arr[1]);\n    let n = bstr.length;\n    const u8arr = new Uint8Array(n);\n    while (n) {\n      u8arr[n - 1] = bstr.charCodeAt(n - 1);\n      n -= 1; // to make eslint happy\n    }\n    return new File([u8arr], filename, { type: mime });\n  };\n\n  return { lng, lat, sendAudio, sendPic, sendBearing };\n};\nexport default useRoute;\n","const Header = () => {\n  return (\n    <div className=\"header\">\n      <h1>GPS Improment System</h1>\n      <p>\n        This Website helps you to improve your GPS location when taking the Taipei MRT.\n      </p>\n    </div>\n  );\n};\n\nexport default Header;","const Map = ({mapContainer, lng, lat, zoom, onMove}) => {\n  return (\n    <div>\n      <div className=\"sidebar\">\n        Longitude: {lng} | Latitude: {lat} | Zoom: {zoom}\n      </div>\n      <div ref={mapContainer} className=\"map-container\" />\n    </div>\n  );\n};\nexport default Map;","import { useState } from \"react\";\nimport { ReactMic } from \"react-mic\";\n\nconst Recorder = ({ sendAudio }) => {\n  // const [blob, setBlob] = useState(null);\n  const [record, setRecord] = useState(false);\n\n  const startRecording = () => {\n    setRecord(true);\n  };\n\n  const stopRecording = () => {\n    setRecord(false);\n  };\n\n  const onData = (recordedBlob) => {\n    // console.log(\"chunk of real-time data is: \", recordedBlob);\n    // console.log(recordedBlob)\n    // sendAudio(recordedBlob)\n  };\n\n  const onStop = (recordedBlob) => {\n    // console.log('recordedBlob is: ', recordedBlob);\n    sendAudio(recordedBlob);\n  };\n  return (\n    <div>\n      <ReactMic\n        record={record}\n        mimeType=\"audio/wav\"\n        className=\"sound-wave\"\n        onStop={onStop}\n        onData={onData}\n        strokeColor=\"#000000\"\n        timeSlice={30000}\n        backgroundColor=\"#FF4081\"\n      />\n      <button onClick={startRecording} type=\"button\">\n        Start\n      </button>\n      <button onClick={stopRecording} type=\"button\">\n        Stop\n      </button>\n    </div>\n  );\n};\nexport default Recorder;\n","import { useState } from \"react\";\nimport * as THREE from \"three\";\nimport { Gyroscope, AbsoluteOrientationSensor } from \"motion-sensors-polyfill\";\n\nconst useSensor = () => {\n  const [bearing, setBearing] = useState(0);\n  \n  const orientation = () => {\n    const options = { frequency: 60 };\n    const sensor = new AbsoluteOrientationSensor(options);\n    Promise.all([\n      navigator.permissions.query({ name: \"accelerometer\" }),\n      navigator.permissions.query({ name: \"magnetometer\" }),\n      navigator.permissions.query({ name: \"gyroscope\" }),\n    ]).then((results) => {\n      if (results.every((result) => result.state === \"granted\")) {\n        sensor.addEventListener(\"reading\", () => {\n          const euler = new THREE.Euler();\n          const quaternion = new THREE.Quaternion(...sensor.quaternion);\n          // console.log(euler.setFromQuaternion(quaternion, \"XYZ\").z);\n          setBearing(180 / Math.PI * euler.setFromQuaternion(quaternion, \"XYZ\").z);\n        });\n        sensor.addEventListener(\"error\", (event) => {\n          if (event.error.name === \"NotReadableError\") {\n            console.log(\"Sensor is not available.\", event);\n          }\n        });\n        sensor.start();\n      } else {\n        console.log(\"No permissions to use AbsoluteOrientationSensor.\");\n      }\n    });\n  };\n  return {\n    bearing,\n    orientation,\n  };\n};\n\nexport default useSensor;\n","import Webcam from \"react-webcam\";\nimport React, {useRef} from 'react';\n\nconst videoConstraints = {\n    width: 1280,\n    height: 720,\n    // facingMode: { exact: \"environment\" }\n    facingMode: \"user\"\n  };\n\nconst WebCamContainer = ({sendPic}) =>{\n  const webcamRef = React.useRef(null);\n  const capture = React.useCallback(\n    () => {\n      const imageSrc = webcamRef.current.getScreenshot();\n    //   console.log(imageSrc);\n      sendPic(imageSrc);\n    },\n    [webcamRef]\n  );\n\n  return (\n    <>\n    <button onClick={capture}>Capture photo</button>\n    <Webcam\n        audio={false}\n        height={720}\n        ref={webcamRef}\n        screenshotFormat=\"image/jpeg\"\n        width={1280}\n        videoConstraints={videoConstraints}\n    />\n    </>\n);\n}\n\nexport default WebCamContainer;","import { useEffect, useRef, useState } from \"react\";\nimport mapboxgl from \"!mapbox-gl\"; // eslint-disable-line\nimport Map from \"../Components/Map\";\nimport Recorder from \"./Recorder\";\nimport useRoute from \"../hooks/useRoute\";\nimport useSensor from \"../hooks/useSensor\";\nimport Webcam from \"./WebCam\";\n// import orientation from \"../Functions/Orientation\";\n\nmapboxgl.accessToken =\n  \"pk.eyJ1Ijoic2hpbmUtY2hhbmciLCJhIjoiY2tvODhkdGw3MXU2dDJ2bHJrNDZmNHp6ZSJ9.-cSgmT-mTMNGs-to2jNmAw\";\n\nconst MapController = () => {\n  const mapContainer = useRef(null);\n  const map = useRef(null);\n  const { lat, lng, id, sendAudio, sendPic, sendBearing} = useRoute();\n  const [marker, setMarker] = useState(null);\n  const [zoom, setZoom] = useState(13);\n  const { bearing, orientation } = useSensor();\n  const [lastBearing, setLastBearing] = useState(0);\n  const bearingThreshhold = 50;\n  // const onMove = () => {\n  //   setLng(map.current.getCenter().lng.toFixed(4));\n  //   setLat(map.current.getCenter().lat.toFixed(4));\n  //   setZoom(map.current.getZoom().toFixed(2));\n  // };\n\n  useEffect(() => {\n    if (map.current) {\n      map.current.flyTo({ center: [lng, lat], zoom: 14 });\n      let newMarker = marker;\n      setMarker(newMarker.setLngLat([lng, lat]).addTo(map.current));\n    }\n  }, [lng, lat, marker]);\n\n  useEffect(() => {\n    if (!map.current) return;\n    map.current.setBearing(bearing);\n    console.log(\"bearing: \",bearing, lastBearing);\n    if(Math.abs(bearing - lastBearing) > bearingThreshhold){\n        setLastBearing(bearing)\n        sendBearing(bearing);\n      }\n  }, [bearing]);\n\n  useEffect(() => {\n    if (map.current) return; // initialize map only once\n    map.current = new mapboxgl.Map({\n      container: mapContainer.current,\n      style: \"mapbox://styles/mapbox/streets-v11\",\n      center: [lng, lat],\n      pitch: 30,\n      zoom: zoom,\n    });\n    orientation();\n    setMarker(\n      new mapboxgl.Marker({\n        color: \"#1e90ff\",\n        draggable: true,\n      })\n        .setLngLat([lng, lat])\n        .addTo(map.current)\n    );\n  });\n  return (\n    <>\n      <Map mapContainer={mapContainer} lng={lng} lat={lat} zoom={zoom}></Map>\n      <Recorder sendAudio={sendAudio} />\n      <Webcam sendPic={sendPic}/>\n    </>\n  );\n};\nexport default MapController;\n\n// const setUsersLocation = (location) => {\n//   renderMap([data.coords.longitude, data.coords.latitude]);\n//   map.flyTo({ center: [location.longitude, location.latitude] });\n// };\n","import \"./App.css\";\nimport Header from \"./Components/Header\";\nimport MapController from \"./Containers/MapController\";\n\nfunction App() {\n  return (\n    <>\n      <Header />\n      <MapController />\n    </>\n  );\n}\n\nexport default App;\n","const reportWebVitals = onPerfEntry => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport reportWebVitals from './reportWebVitals';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n"],"sourceRoot":""}